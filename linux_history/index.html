<!DOCTYPE html>
<html>
<head>
  <title>Linux 命令搜索</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css">
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
</head>
<body>
  <div id="app" class="ui container">
    <h2 class="ui header">Linux 命令历史搜索</h2>

    <div class="ui fluid icon input">
      <input type="text" v-model="searchQuery" placeholder="搜索命令、主机名、用户...">
      <i class="search icon"></i>
    </div>

    <div class="ui fluid icon input" style="margin-top: 10px;">
      <input type="text" v-model="excludeCommands" placeholder="输入要排除的命令 (例如：ls, echo)">
      <i class="filter icon"></i>
    </div>

    <table class="ui celled table" style="margin-top: 20px;">
      <thead>
        <tr>
          <th>命令</th>
          <th>主机名</th>
          <th>IP 地址</th>
          <th>用户</th>
          <th>执行时间</th>
          <th>操作系统版本</th>
          <th>备注</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="command in filteredCommands" :key="command.id">
          <td>{{ command.get('command') }}</td>
          <td>{{ command.get('hostname') }}</td>
          <td>{{ command.get('ip_address') }}</td>
          <td>{{ command.get('user') }}</td>
          <td>{{ formatBeijingTime(command.get('execution_time')) }}</td>
          <td>{{ command.get('os_version') }}</td>
          <td>
            <div class="ui action input">
              <input type="text" v-model="command.updatedRemark" :placeholder="command.get('remark') || '输入备注...'">
              <button class="ui primary button" @click="saveRemark(command)">保存</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    const { createApp, ref, computed } = Vue;

    // 初始化 Parse
    Parse.initialize("happen-app", "YOUR_JAVASCRIPT_KEY");
    Parse.serverURL = 'https://parse.ali.glwsq.cn/parse';

    const LinuxCommand = Parse.Object.extend("LinuxCommand");

    createApp({
      setup() {
        const searchQuery = ref('');
        const excludeCommands = ref('ls, echo, pwd'); // 默认排除一些常用命令
        const commands = ref([]);

        async function fetchCommands() {
          const query = new Parse.Query(LinuxCommand);
          query.descending("execution_time");
          commands.value = await query.find();
          commands.value.forEach(command => {
            command.updatedRemark = command.get('remark') || '';
          });
        }

        function formatBeijingTime(utcTime) {
          const date = new Date(utcTime);
          date.setHours(date.getHours());
          return date.toLocaleString();
        }

        async function saveRemark(command) {
          command.set('remark', command.updatedRemark);
          await command.save();
          fetchCommands();
        }

        const filteredCommands = computed(() => {
          let filtered = commands.value;
          if (searchQuery.value) {
            const query = searchQuery.value.toLowerCase();
            filtered = filtered.filter(command => {
              return (
                command.get('command').toLowerCase().includes(query) ||
                command.get('hostname').toLowerCase().includes(query) ||
                command.get('ip_address').toLowerCase().includes(query) ||
                command.get('user').toLowerCase().includes(query) ||
                (command.get('remark') && command.get('remark').toLowerCase().includes(query))
              );
            });
          }
          if (excludeCommands.value) {
            const excludes = excludeCommands.value.toLowerCase().split(',').map(cmd => cmd.trim());
            filtered = filtered.filter(command => {
              return !excludes.some(exclude => command.get('command').toLowerCase() === exclude);
            });
          }
          return filtered;
        });

        fetchCommands();

        return {
          searchQuery, excludeCommands, commands, filteredCommands, formatBeijingTime, saveRemark
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
