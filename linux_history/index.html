<!DOCTYPE html>
<html>
<head>
  <title>Linux Command Search</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css">
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div id="app" class="ui container" v-cloak>
    <!-- <div v-if="!currentUser" class="ui message">
      <a href="/login.html">Please log in to view your command history</a>
    </div> -->
    <!-- <div v-else> -->
      <h2 class="ui header">Linux Command History Search</h2>
      <!-- <a href="/login.html" class="ui button">Logout</a> -->

      <div class="ui fluid icon input">
        <input type="text" v-model="searchQuery" placeholder="Search commands, hostname, user...">
        <i class="search icon"></i>
      </div>

      <table class="ui celled table">
        <thead>
          <tr>
            <th>Command</th>
            <th>Hostname</th>
            <th>IP Address</th>
            <th>User</th>
            <th>Execution Time (Beijing Time)</th>
            <th>OS Version</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="command in filteredCommands" :key="command.id">
            <td>{{ command.get('command') }}</td>
            <td>{{ command.get('hostname') }}</td>
            <td>{{ command.get('ip_address') }}</td>
            <td>{{ command.get('user') }}</td>
            <td>{{ formatBeijingTime(command.get('execution_time')) }}</td>
            <td>{{ command.get('os_version') }}</td>
          </tr>
        </tbody>
      </table>
    <!-- </div> -->
  </div>

  <script type="module">
    const { createApp, ref, computed } = Vue;

    // Initialize Parse
    Parse.initialize("happen-app", "YOUR_JAVASCRIPT_KEY");
    Parse.serverURL = 'https://parse.ali.glwsq.cn/parse';

    const LinuxCommand = Parse.Object.extend("LinuxCommand");

    createApp({
      setup() {
        const currentUser = ref(Parse.User.current());
        const searchQuery = ref('');
        const commands = ref([]);

        async function fetchCommands() {
          const query = new Parse.Query(LinuxCommand);
        //   query.equalTo("user", currentUser.value);
          query.descending("execution_time");
          commands.value = await query.find();
        }

        function formatBeijingTime(utcTime) {
          const date = new Date(utcTime);
          date.setHours(date.getHours() + 8); // Convert to Beijing Time (UTC+8)
          return date.toLocaleString();
        }

        const filteredCommands = computed(() => {
          if (!searchQuery.value) {
            return commands.value;
          }
          const query = searchQuery.value.toLowerCase();
          return commands.value.filter(command => {
            return (
              command.get('command').toLowerCase().includes(query) ||
              command.get('hostname').toLowerCase().includes(query) ||
              command.get('ip_address').toLowerCase().includes(query) ||
              command.get('user').toLowerCase().includes(query)
            );
          });
        });

        // if (currentUser.value) {
        fetchCommands();
        // }

        return {
          currentUser, searchQuery, commands, filteredCommands, formatBeijingTime
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
