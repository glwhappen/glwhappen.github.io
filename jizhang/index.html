<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue 3 & Parse å®ç°çš„ç®€æ˜“è®°è´¦è½¯ä»¶</title>
  <!-- å¼•å…¥ Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- å¼•å…¥ Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- å¼•å…¥ Parse JS SDK -->
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }

    .container {
      margin-top: 50px;
    }

    .v-cloak {
      display: none;
    }

    .delete-button:hover {
      color: red;
    }
  </style>
</head>

<body>
  <div id="app" class="container" v-cloak>
    <h1 class="text-center mb-4">ğŸ“’ ç®€æ˜“è®°è´¦è½¯ä»¶</h1>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card text-white bg-success mb-3">
          <div class="card-header">æ€»æ”¶å…¥</div>
          <div class="card-body">
            <h5 class="card-title">{{ totalIncome.toFixed(2) }} å…ƒ</h5>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-white bg-danger mb-3">
          <div class="card-header">æ€»æ”¯å‡º</div>
          <div class="card-body">
            <h5 class="card-title">{{ totalExpense.toFixed(2) }} å…ƒ</h5>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div :class="['card', balance >= 0 ? 'bg-primary' : 'bg-warning', 'text-white', 'mb-3']">
          <div class="card-header">ä½™é¢</div>
          <div class="card-body">
            <h5 class="card-title">{{ balance.toFixed(2) }} å…ƒ</h5>
          </div>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ è®°å½•è¡¨å• -->
    <div class="card mb-4">
      <div class="card-header">æ·»åŠ æ–°è®°å½•</div>
      <div class="card-body">
        <form @submit.prevent="addRecord">
          <div class="row mb-3">
            <div class="col-md-3">
              <label for="date" class="form-label">æ—¥æœŸ</label>
              <input type="date" id="date" v-model="newRecord.date" class="form-control" required>
            </div>
            <div class="col-md-3">
              <label for="type" class="form-label">ç±»å‹</label>
              <select id="type" v-model="newRecord.type" class="form-select" required>
                <option disabled value="">è¯·é€‰æ‹©ç±»å‹</option>
                <option>æ”¶å…¥</option>
                <option>æ”¯å‡º</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="amount" class="form-label">é‡‘é¢</label>
              <input type="number" id="amount" v-model.number="newRecord.amount" class="form-control" min="0.01" step="0.01" required>
            </div>
            <div class="col-md-3">
              <label for="description" class="form-label">æè¿°</label>
              <input type="text" id="description" v-model="newRecord.description" class="form-control" placeholder="ä¾‹å¦‚ï¼šå·¥èµ„ã€é¤é¥®ç­‰" required>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">æ·»åŠ è®°å½•</button>
        </form>
      </div>
    </div>

    <!-- è®°å½•å±•ç¤º -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>ğŸ“‹ è®°å½•åˆ—è¡¨</span>
        <div>
          <label for="filterMonth" class="form-label me-2">ç­›é€‰æœˆä»½:</label>
          <input type="month" id="filterMonth" v-model="filterMonth" class="form-control d-inline-block" style="width: auto;">
        </div>
      </div>
      <div class="card-body">
        <ul class="list-group" ref="recordList">
          <li v-for="record in filteredRecords" :key="record.id" class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ formatDate(record.date) }}</strong> -
              <span :class="record.type === 'æ”¶å…¥' ? 'text-success' : 'text-danger'">{{ record.type }}</span> -
              {{ record.description }} -
              <span :class="record.type === 'æ”¶å…¥' ? 'text-success' : 'text-danger'">{{ record.amount.toFixed(2) }} å…ƒ</span>
            </div>
            <div>
              <button class="btn btn-sm btn-secondary me-2" @click="editRecord(record)">ç¼–è¾‘</button>
              <button class="btn btn-sm btn-danger" @click="deleteRecord(record)">åˆ é™¤</button>
            </div>
          </li>
          <li v-if="filteredRecords.length === 0" class="list-group-item text-center">æš‚æ— è®°å½•</li>
        </ul>
      </div>
    </div>

    <!-- ç¼–è¾‘è®°å½•æ¨¡æ€æ¡† -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true" ref="editModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">ç¼–è¾‘è®°å½•</h5>
            <button type="button" class="btn-close" @click="closeEditModal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="updateRecord">
              <div class="mb-3">
                <label for="editDate" class="form-label">æ—¥æœŸ</label>
                <input type="date" id="editDate" v-model="editRecordData.date" class="form-control" required>
              </div>
              <div class="mb-3">
                <label for="editType" class="form-label">ç±»å‹</label>
                <select id="editType" v-model="editRecordData.type" class="form-select" required>
                  <option>æ”¶å…¥</option>
                  <option>æ”¯å‡º</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="editAmount" class="form-label">é‡‘é¢</label>
                <input type="number" id="editAmount" v-model.number="editRecordData.amount" class="form-control" min="0.01" step="0.01" required>
              </div>
              <div class="mb-3">
                <label for="editDescription" class="form-label">æè¿°</label>
                <input type="text" id="editDescription" v-model="editRecordData.description" class="form-control" required>
              </div>
              <button type="submit" class="btn btn-primary">ä¿å­˜æ›´æ”¹</button>
              <button type="button" class="btn btn-secondary" @click="closeEditModal">å–æ¶ˆ</button>
            </form>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- å¼•å…¥ Bootstrap 5 JS å’Œä¾èµ– -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const { createApp, ref, onMounted, computed, watch, nextTick } = Vue;

    // åˆå§‹åŒ– Parse
    Parse.initialize("happen-app", "YOUR_JAVASCRIPT_KEY");
    Parse.serverURL = 'https://parse.ali.glwsq.cn/parse';

    const Record = Parse.Object.extend("Record");

    createApp({
      setup() {
        const records = ref([]);
        const newRecord = ref({
          date: '',
          type: '',
          amount: 0,
          description: ''
        });
        const filterMonth = ref('');
        const editRecordData = ref({
          id: null,
          date: '',
          type: '',
          amount: 0,
          description: ''
        });
        const editModal = ref(null);
        let modalInstance = null;

        const currentUser = ref(Parse.User.current());
        if (!currentUser.value) {
            window.location.href = '/login.html';
        }
        // è®¡ç®—æ€»æ”¶å…¥
        const totalIncome = computed(() => {
          return records.value
            .filter(r => r.type === 'æ”¶å…¥')
            .reduce((sum, r) => sum + r.amount, 0);
        });

        // è®¡ç®—æ€»æ”¯å‡º
        const totalExpense = computed(() => {
          return records.value
            .filter(r => r.type === 'æ”¯å‡º')
            .reduce((sum, r) => sum + r.amount, 0);
        });

        // è®¡ç®—ä½™é¢
        const balance = computed(() => {
          return totalIncome.value - totalExpense.value;
        });

        // è¿‡æ»¤åçš„è®°å½•
        const filteredRecords = computed(() => {
          let filtered = records.value;
          if (filterMonth.value) {
            filtered = filtered.filter(r => r.date.startsWith(filterMonth.value));
          }
          // æŒ‰æ—¥æœŸé™åºæ’åº
          return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        });

        // æ ¼å¼åŒ–æ—¥æœŸ
        const formatDate = (dateStr) => {
          const options = { year: 'numeric', month: 'short', day: 'numeric' };
          return new Date(dateStr).toLocaleDateString('zh-CN', options);
        };

        // è·å–å½“å‰ç”¨æˆ·çš„è®°å½•
        const fetchRecords = async () => {
          if (!currentUser.value) {
            records.value = [];
            return;
          }
          try {
            const query = new Parse.Query(Record);
            query.equalTo("author", currentUser.value);
            query.ascending("date");
            const results = await query.find();
            records.value = results.map(obj => ({
              id: obj.id,
              date: obj.get('date'),
              type: obj.get('type'),
              amount: obj.get('amount'),
              description: obj.get('description')
            }));
            scrollToBottom();
          } catch (error) {
            console.error("è·å–è®°å½•å¤±è´¥:", error);
          }
        };

        // æ·»åŠ æ–°è®°å½•
        const addRecord = async () => {
          if (!currentUser.value) {
            alert('è¯·ç™»å½•åå†æ·»åŠ è®°å½•ã€‚');
            return;
          }
          // è¡¨å•éªŒè¯
          if (!newRecord.value.date || !newRecord.value.type || !newRecord.value.description || newRecord.value.amount <= 0) {
            alert('è¯·å¡«å†™å®Œæ•´çš„è®°å½•ä¿¡æ¯ï¼Œå¹¶ç¡®ä¿é‡‘é¢å¤§äº0ã€‚');
            return;
          }

          try {
            const record = new Record();
            record.set('date', newRecord.value.date);
            record.set('type', newRecord.value.type);
            record.set('amount', parseFloat(newRecord.value.amount));
            record.set('description', newRecord.value.description);
            record.set('author', currentUser.value);

            // è®¾ç½® ACL ä»…å½“å‰ç”¨æˆ·å¯è¯»å†™
            const acl = new Parse.ACL(currentUser.value);
            acl.setPublicReadAccess(false);
            acl.setPublicWriteAccess(false);
            record.setACL(acl);

            await record.save();
            records.value.push({
              id: record.id,
              date: record.get('date'),
              type: record.get('type'),
              amount: record.get('amount'),
              description: record.get('description')
            });
            resetNewRecord();
            scrollToBottom();
          } catch (error) {
            console.error("æ·»åŠ è®°å½•å¤±è´¥:", error);
          }
        };

        // ç¼–è¾‘è®°å½•
        const editRecord = (record) => {
          editRecordData.value = { ...record };
          modalInstance = new bootstrap.Modal(editModal.value);
          modalInstance.show();
        };

        // æ›´æ–°è®°å½•
        const updateRecord = async () => {
          // è¡¨å•éªŒè¯
          if (!editRecordData.value.date || !editRecordData.value.type || !editRecordData.value.description || editRecordData.value.amount <= 0) {
            alert('è¯·å¡«å†™å®Œæ•´çš„è®°å½•ä¿¡æ¯ï¼Œå¹¶ç¡®ä¿é‡‘é¢å¤§äº0ã€‚');
            return;
          }

          try {
            const record = new Parse.Query(Record).get(editRecordData.value.id);
            record.set('date', editRecordData.value.date);
            record.set('type', editRecordData.value.type);
            record.set('amount', parseFloat(editRecordData.value.amount));
            record.set('description', editRecordData.value.description);
            await record.save();

            const index = records.value.findIndex(r => r.id === editRecordData.value.id);
            if (index !== -1) {
              records.value[index] = { ...editRecordData.value };
            }
            closeEditModal();
          } catch (error) {
            console.error("æ›´æ–°è®°å½•å¤±è´¥:", error);
          }
        };

        // åˆ é™¤è®°å½•
        const deleteRecord = async (record) => {
          if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
          try {
            const parseRecord = new Parse.Object('Record');
            parseRecord.id = record.id;
            await parseRecord.destroy();

            records.value = records.value.filter(r => r.id !== record.id);
          } catch (error) {
            console.error("åˆ é™¤è®°å½•å¤±è´¥:", error);
          }
        };

        // é‡ç½®æ–°è®°å½•è¡¨å•
        const resetNewRecord = () => {
          newRecord.value = {
            date: '',
            type: '',
            amount: 0,
            description: ''
          };
        };

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        const closeEditModal = () => {
          if (modalInstance) {
            modalInstance.hide();
          }
        };

        // æ»šåŠ¨åˆ°æœ€æ–°è®°å½•
        const scrollToBottom = () => {
          nextTick(() => {
            const list = document.querySelector('.list-group');
            if (list) {
              list.scrollTop = list.scrollHeight;
            }
          });
        };

        onMounted(() => {
          fetchRecords();
          // ç›‘å¬ç”¨æˆ·ç™»å½•çŠ¶æ€å˜åŒ–
          Parse.User.currentAsync().then(user => {
            currentUser.value = user;
            fetchRecords();
          });

          // åˆå§‹åŒ–ç¼–è¾‘æ¨¡æ€æ¡†
          editModal.value = document.getElementById('editModal');
        });

        // ç›‘å¬è®°å½•å˜åŒ–ï¼Œè‡ªåŠ¨ä¿å­˜ï¼ˆå¦‚æœéœ€è¦ï¼‰
        watch(records, () => {
          // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é¢å¤–çš„é€»è¾‘
        }, { deep: true });

        return {
          records,
          newRecord,
          addRecord,
          totalIncome,
          totalExpense,
          balance,
          filteredRecords,
          filterMonth,
          editRecord,
          deleteRecord,
          editRecordData,
          updateRecord,
          closeEditModal,
          formatDate
        };
      }
    }).mount('#app');
  </script>
</body>

</html>
